<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Pose-controlled Music Webapp</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { margin: 0; font-family: Arial, sans-serif; display:flex; gap:20px; padding:20px; background:#111; color:#eee; align-items:flex-start; }
    #left { width:640px; }
    #controls { width:360px; display:flex; flex-direction:column; gap:12px; }
    canvas { background:#222; border-radius:8px; }
    button, select { padding:10px; font-size:16px; border-radius:6px; border: none; }
    .big { font-size:18px; padding:12px; }
    .info { background:#141414; padding:12px; border-radius:8px; color:#ddd; }
    label { font-size:14px; }
  </style>
  <!-- MediaPipe Pose JS (cdn) -->
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/pose.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@mediapipe/drawing_utils/drawing_utils.js"></script>
</head>
<body>
  <div id="left">
    <video id="video" autoplay playsinline style="display:none;"></video>
    <canvas id="canvas" width="640" height="480"></canvas>
  </div>

  <div id="controls">
    <div class="info">
      <div><strong>Controls:</strong></div>
      <div>ðŸ‘‹ Left wrist â†’ tap origin circle â†’ tempo/BPM</div>
      <div>âœ‹ Right wrist â†’ up/down â†’ volume</div>
    </div>

    <select id="songSelect" class="big">
      <option value="">Select a song</option>
      <option value="https://drive.google.com/uc?export=download&id=1dSuG7DN2iCSBdkdwj5qdm_ksk-vWg5qa">Mahler Adagietto</option>
      <option value="https://drive.google.com/uc?export=download&id=1IXkMTfYC-JwiN6p9kIB28trcn1-MvjkC">Mozart Nachtmusik</option>
      <option value="https://drive.google.com/uc?export=download&id=1Vv2nGpouHiXRGIa3npB08VrwHJr_obPc">Tchaikovsky Fairy</option>
    </select>

    <button id="startBtn" class="big">Start</button>
    <button id="stopBtn" class="big" disabled>Stop</button>

    <div class="info">
      <div>Status: <span id="status">idle</span></div>
      <div>BPM: <span id="bpm">â€”</span></div>
      <div>Speed: <span id="speed">1.00</span>x</div>
      <div>Volume: <span id="vol">0.50</span></div>
    </div>
  </div>

<script>
(async function(){
  const video = document.getElementById('video');
  const canvas = document.getElementById('canvas');
  const ctx = canvas.getContext('2d');

  const startBtn = document.getElementById('startBtn');
  const stopBtn  = document.getElementById('stopBtn');
  const songSelect = document.getElementById('songSelect');
  const statusEl = document.getElementById('status');
  const bpmEl = document.getElementById('bpm');
  const speedEl = document.getElementById('speed');
  const volEl = document.getElementById('vol');

  // parameters
  let origin = {x: 320, y: 240};
  let minDist = 40;
  let audio = new Audio();
  audio.loop = true;
  let speed = 1.0, volume = 0.5, start_time=null, lastTempoTime=0;
  const alpha=0.12, original_bpm=75, tempoInterval=1.8;

  function dist(x1,y1,x2,y2){return Math.hypot(x1-x2,y1-y2);}

  const pose = new Pose({locateFile: (f)=>`https://cdn.jsdelivr.net/npm/@mediapipe/pose@0.5/${f}`});
  pose.setOptions({modelComplexity:1, smoothLandmarks:true, minDetectionConfidence:0.6, minTrackingConfidence:0.6});
  pose.onResults(onResults);

  const camera = new Camera(video, {onFrame:async()=>{await pose.send({image:video})}, width:640,height:480});

  function draw(results){
    ctx.clearRect(0,0,canvas.width,canvas.height);
    ctx.drawImage(results.image,0,0,canvas.width,canvas.height);
    // origin
    ctx.beginPath(); ctx.arc(origin.x,origin.y,8,0,Math.PI*2); ctx.fillStyle="red"; ctx.fill();
    const mid=canvas.height/2; ctx.beginPath(); ctx.moveTo(0,mid); ctx.lineTo(canvas.width,mid); ctx.strokeStyle="yellow"; ctx.stroke();
  }

  function onResults(res){
    draw(res);
    if(!res.poseLandmarks)return;
    const L=res.poseLandmarks[15], R=res.poseLandmarks[16];
    const lx=L.x*canvas.width, ly=L.y*canvas.height, rx=R.x*canvas.width, ry=R.y*canvas.height;
    // draw wrists
    ctx.beginPath(); ctx.arc(lx,ly,10,0,Math.PI*2); ctx.fillStyle="cyan"; ctx.fill();
    ctx.beginPath(); ctx.arc(rx,ry,10,0,Math.PI*2); ctx.fillStyle="orange"; ctx.fill();

    // Left wrist -> BPM
    if(dist(lx,ly,origin.x,origin.y)<minDist){
      const now=performance.now()/1000;
      if(!start_time){start_time=now;}
      else{
        const rt=now-start_time;
        if(rt>0.15&&rt<10){
          const bpm=60/rt; bpmEl.textContent=Math.round(bpm);
          if(now-lastTempoTime>=tempoInterval){
            const target=Math.max(0.3,Math.min(3,bpm/original_bpm));
            speed=(1-alpha)*speed+alpha*target; audio.playbackRate=speed;
            speedEl.textContent=speed.toFixed(2); lastTempoTime=now;
          }
        }
        start_time=now;
      }
    }
    // Right wrist -> volume
    const mid=canvas.height/2;
    const step=(mid-ry)/mid*0.01;
    volume=0.92*volume+0.08*Math.max(0.05,Math.min(1,volume+step));
    audio.volume=volume; volEl.textContent=audio.volume.toFixed(2);
  }

  startBtn.onclick=async()=>{
    if(!songSelect.value){alert("Pick a song");return;}
    const blob=await fetch(songSelect.value).then(r=>r.blob());
    audio.src=URL.createObjectURL(blob);
    await audio.play(); await camera.start();
    startBtn.disabled=true; stopBtn.disabled=false; songSelect.disabled=true;
    statusEl.textContent="running";
  };
  stopBtn.onclick=async()=>{
    audio.pause(); camera.stop();
    startBtn.disabled=false; stopBtn.disabled=true; songSelect.disabled=false;
    statusEl.textContent="stopped";
    bpmEl.textContent="â€”"; speedEl.textContent="1.00"; volEl.textContent="0.50";
    speed=1; volume=0.5; audio.playbackRate=1; audio.volume=0.5;
  };
})();
</script>
</body>
</html>
